<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
    <meta
      http-equiv="Content-Security-Policy"
      content="script-src 'self' 'unsafe-inline' 'unsafe-eval'"
    />
    <title>Movie Tracker</title>
    <link
      rel="stylesheet"
      href="node_modules/bootstrap/dist/css/bootstrap.min.css"
    />

    <script>
      //required for mongodb access
      const { MongoClient } = require("mongodb");

      //required jquery and datatabels
      var $ = (jQuery = require("jquery"));
      require("datatables.net")();

      async function listMoviesMainDBCall() {
        const client = new MongoClient(
          "<MongoDB connection String Here>",
          {
            useNewUrlParser: true,
            useUnifiedTopology: true,
          }
        );

        try {
          // Connect to the MongoDB cluster
          await client.connect();

          // Make the appropriate DB calls
          await listMovies(client);
        } catch (e) {
          console.error(e);
        } finally {
          // Close the connection to the MongoDB cluster
          await client.close();
        }
      }

      //runs the function at start
      listMoviesMainDBCall().catch(console.error);

      //List all the movies inside the MongoDB
      async function listMovies(client) {
        //captures all data from the movies collection
        const cursor = await client.db().collection("MovieTest").find();

        //assigns retult data
        const results = await cursor.toArray();

        //Table creation with data
        $(document).ready(function () {
          var table = $("#example").DataTable({
            data: results,
            scrollY: "50vh",
            scrollCollapse: true,
            paging: false,
            columns: [
              //{ title:"ID" ,data: "_id" },
              { title: "Name", data: "Name" },
              { title: "Own", data: "Own" },
              { title: "Type", data: "Type" },
              { title: "Source", data: "Source" },
              /* DELETE */ {
                mRender: function (data, type, row) {
                  return (
                    '<a class="btn btn-danger js-delete" data-id="' +
                    row._id +
                    '">DELETE</a>'
                  );
                },
              },
            ],
          });

          document
            .getElementById("btnSubmit")
            .addEventListener("click", function (event) {
              event.preventDefault();

              var nameValue = document.getElementById("movieName").value;
              var ownValue = document.getElementById("movieOwn").value;
              var typeValue = document.getElementById("movieType").value;
              var sourceValue = document.getElementById("movieSource").value;

              var movie = {
                Name: nameValue,
                Own: ownValue,
                Type: typeValue,
                Source: sourceValue,
              };

              addItem(movie);

              table.row
                .add({
                  Name: nameValue,
                  Own: ownValue,
                  Type: typeValue,
                  Source: sourceValue,
                })
                .draw();
            });

          $("#example").on("click", ".js-delete", function () {
            var button = $(this);
            if (
              confirm("Are you sure you want to delete this from the database?")
            ) {
              deleteMovie(button.attr("data-id"));
              table.row(button.parents("tr")).remove().draw();
              console.log("Movie was deleted!");
            } else {
              console.log("Movie was not deleted");
            }
          });
        });
      }

      async function deleteListingByID(client, idOfListing) {
        var mongoose = require("mongoose");
        var objectId = mongoose.Types.ObjectId(idOfListing);

        const result = await client
          .db()
          .collection("MovieTest")
          .deleteOne({ _id: objectId });
        console.log("Movie Removed");
      }

      async function deleteMovie(id) {
        const client = new MongoClient(
          "<MongoDB connection String Here>",
          {
            useNewUrlParser: true,
            useUnifiedTopology: true,
          }
        );

        try {
          // Connect to the MongoDB cluster
          await client.connect();

          // Make the appropriate DB calls
          await deleteListingByID(client, id);
        } catch (e) {
          console.error(e);
        } finally {
          // Close the connection to the MongoDB cluster
          await client.close();
        }
      }

      async function addMovie(movie) {
        const client = new MongoClient(
          "<MongoDB connection String Here>",
          {
            useNewUrlParser: true,
            useUnifiedTopology: true,
          }
        );

        try {
          // Connect to the MongoDB cluster
          await client.connect();

          // Make the appropriate DB calls
          await createListing(client, movie);
        } catch (e) {
          console.error(e);
        } finally {
          // Close the connection to the MongoDB cluster
          await client.close();
        }
      }

      function addItem(item) {
        if (
          item.Name === "" ||
          item.Own === "" ||
          item.Type === "" ||
          item.Source === ""
        ) {
          alert("Please enter all fields");
          return false;
        }
        addMovie(item);
      }

      async function createListing(client, newListing) {
        const result = await client
          .db()
          .collection("MovieTest")
          .insertOne(newListing);
        console.log(
          `New listing created with the following id: ${result.insertedId}`
        );
      }
    </script>
  </head>
  <body>
    <div class="container mt-5">
      <table
        id="example"
        class="table table-striped"
        style="width: 100%"
      ></table>

      <div class="mt-5">
        <form>
          <div class="row">
            <div class="col-6">
              <div class="input-group mb-3">
                <span class="input-group-text">Title</span>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Movie Title"
                  aria-label="Movie Title"
                  id="movieName"
                  name="movieName"
                />
              </div>
            </div>
            <dic class="col-6">
              <div class="input-group mb-3">
                <label class="input-group-text" for="movieOwn">Own</label>
                <select class="form-select" id="movieOwn">
                  <option selected value="">Choose...</option>
                  <option value="ALL">ALL</option>
                  <option value="Cody">Cody</option>
                  <option value="Sue/Buddy">Sue/Buddy</option>
                </select>
              </div>
            </dic>
          </div>

          <div class="row">
            <div class="col-6">
              <div class="input-group mb-3">
                <label class="input-group-text" for="movieType">Type</label>
                <select class="form-select" id="movieType">
                  <option selected value="">Choose...</option>
                  <option value="BluRay">BluRay</option>
                  <option value="Digital">Digital</option>
                  <option value="DVD">DVD</option>
                  <option value="VHS">VHS</option>
                </select>
              </div>
            </div>
            <div class="col-6">
              <div class="input-group mb-3">
                <label class="input-group-text" for="movieSource">Source</label>
                <select class="form-select" id="movieSource">
                  <option selected value="">Choose...</option>
                  <option value="Vudu">Vudu</option>
                  <option value="Google Play">Google Play</option>
                  <option value="Disk">Disk</option>
                  <option value="Cassette">Cassette</option>
                </select>
              </div>
            </div>
          </div>
          <button type="submit" id="btnSubmit" class="btn btn-primary">
            Add Movie
          </button>
        </form>
      </div>
    </div>
    <!-- You can also require other files to run in this process -->
    <script src="./renderer.js"></script>
  </body>
</html>
